[phases.setup]
nixPkgs = ["php82", "php82Packages.composer", "nodejs-18_x"]

[phases.install]
cmds = [
    "composer install --no-dev --optimize-autoloader --ignore-platform-reqs",
    "npm install"
]

[phases.build]
cmds = ["npm run build"]

[start]
cmd = """
echo "üöÄ INICIANDO APLICACI√ìN CON MIGRACIONES"

# Primero probar conexi√≥n a BD
php -r "
try {
    \\$pdo = new PDO('mysql:host=mysql.railway.internal;dbname=railway', 'root', 'ZFWAcAQLMqDvuJfCqSXKvAMnMmiTCIyS', [
        PDO::ATTR_TIMEOUT => 15,
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION
    ]);
    echo '‚úÖ CONEXI√ìN A BD EXITOSA - EJECUTANDO MIGRACIONES...' . PHP_EOL;
    
    # Ejecutar migraciones
    system('php artisan migrate --force');
    echo '‚úÖ MIGRACIONES COMPLETADAS' . PHP_EOL;
    
} catch (Exception \\$e) {
    echo '‚ùå ERROR DE CONEXI√ìN BD: ' . \\$e->getMessage() . PHP_EOL;
    echo '‚ö†Ô∏è  INICIANDO SIN MIGRACIONES' . PHP_EOL;
}
"

# Iniciar servidor (con o sin migraciones)
php artisan serve --host=0.0.0.0 --port=\$PORT
"""